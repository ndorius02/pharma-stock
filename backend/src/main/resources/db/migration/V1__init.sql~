
-- =========================
-- 0) Helper: updated_at trigger
-- =========================

CREATE OR REPLACE FUNCTION set_updated_at()
RETURNS trigger AS $$
BEGIN
  NEW.updated_at = now();
RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- =========================
-- 1) USER (application users)
-- =========================

CREATE TABLE app_user (
                          id           BIGSERIAL PRIMARY KEY,
                          last_name    VARCHAR(100) NOT NULL,
                          first_name   VARCHAR(100) NOT NULL,
                          email        VARCHAR(255) NOT NULL,
                          password_hash VARCHAR(255) NOT NULL,
                          role         VARCHAR(30) NOT NULL,
                          is_active    BOOLEAN NOT NULL DEFAULT TRUE,
                          created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
                          updated_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
                          CONSTRAINT uq_app_user_email UNIQUE (email),
                          CONSTRAINT ck_app_user_role CHECK (role IN ('ADMIN','STAFF','MANAGER'))
);

CREATE INDEX idx_app_user_is_active ON app_user(is_active);

CREATE TRIGGER trg_app_user_updated_at
    BEFORE UPDATE ON app_user
    FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =========================
-- 2) CATEGORY
-- =========================

CREATE TABLE category (
                          id          BIGSERIAL PRIMARY KEY,
                          name        VARCHAR(150) NOT NULL,
                          description TEXT,
                          is_active   BOOLEAN NOT NULL DEFAULT TRUE,
                          created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
                          updated_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
                          CONSTRAINT uq_category_name UNIQUE (name)
);

CREATE INDEX idx_category_is_active ON category(is_active);

CREATE TRIGGER trg_category_updated_at
    BEFORE UPDATE ON category
    FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =========================
-- 3) LOCATION (internal storage location: shelf, room, etc.)
-- =========================
CREATE TABLE location (
                          id          BIGSERIAL PRIMARY KEY,
                          name        VARCHAR(150) NOT NULL,
                          description TEXT,
                          is_active   BOOLEAN NOT NULL DEFAULT TRUE,
                          created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
                          updated_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
                          CONSTRAINT uq_location_name UNIQUE (name)
);

CREATE INDEX idx_location_is_active ON location(is_active);

CREATE TRIGGER trg_location_updated_at
    BEFORE UPDATE ON location
    FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =========================
-- 4) SUPPLIER
-- =========================
CREATE TABLE supplier (
                          id          BIGSERIAL PRIMARY KEY,
                          name        VARCHAR(200) NOT NULL,
                          vat_number  VARCHAR(50),
                          phone       VARCHAR(50),
                          email       VARCHAR(255),
                          street      VARCHAR(255),
                          postal_code VARCHAR(20),
                          locality    VARCHAR(150),
                          is_active   BOOLEAN NOT NULL DEFAULT TRUE,
                          created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
                          updated_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
                          CONSTRAINT uq_supplier_email UNIQUE (email),
                          CONSTRAINT uq_supplier_vat UNIQUE (vat_number)
);

CREATE INDEX idx_supplier_locality ON supplier(locality);
CREATE INDEX idx_supplier_is_active ON supplier(is_active);

CREATE TRIGGER trg_supplier_updated_at
    BEFORE UPDATE ON supplier
    FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =========================
-- 5) CUSTOMER
-- =========================
CREATE TABLE customer (
                          id          BIGSERIAL PRIMARY KEY,
                          name        VARCHAR(200) NOT NULL,
                          phone       VARCHAR(50),
                          email       VARCHAR(255),
                          street      VARCHAR(255),
                          postal_code VARCHAR(20),
                          locality    VARCHAR(150),
                          is_active   BOOLEAN NOT NULL DEFAULT TRUE,
                          created_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
                          updated_at  TIMESTAMPTZ NOT NULL DEFAULT now(),
                          CONSTRAINT uq_customer_email UNIQUE (email)
);

CREATE INDEX idx_customer_locality ON customer(locality);
CREATE INDEX idx_customer_is_active ON customer(is_active);

CREATE TRIGGER trg_customer_updated_at
    BEFORE UPDATE ON customer
    FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =========================
-- 6) MEDICATION
-- =========================
CREATE TABLE medication (
                            id           BIGSERIAL PRIMARY KEY,
                            name         VARCHAR(200) NOT NULL,
                            sku          VARCHAR(80)  NOT NULL,   -- internal stock keeping unit
                            barcode      VARCHAR(80),             -- EAN/UPC etc.
                            description  TEXT,
                            unit         VARCHAR(30) NOT NULL DEFAULT 'unit', -- e.g. box, bottle, unit
                            min_stock    INTEGER NOT NULL DEFAULT 0,
                            current_stock INTEGER NOT NULL DEFAULT 0,
                            is_active    BOOLEAN NOT NULL DEFAULT TRUE,
                            created_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
                            updated_at   TIMESTAMPTZ NOT NULL DEFAULT now(),
                            category_id  BIGINT REFERENCES category(id),
                            location_id  BIGINT REFERENCES location(id),
                            CONSTRAINT uq_medication_sku UNIQUE (sku),
                            CONSTRAINT uq_medication_barcode UNIQUE (barcode),
                            CONSTRAINT ck_medication_min_stock CHECK (min_stock >= 0),
                            CONSTRAINT ck_medication_current_stock CHECK (current_stock >= 0)
);

CREATE INDEX idx_medication_name ON medication(name);
CREATE INDEX idx_medication_category ON medication(category_id);
CREATE INDEX idx_medication_location ON medication(location_id);
CREATE INDEX idx_medication_is_active ON medication(is_active);
CREATE INDEX idx_medication_low_stock ON medication(current_stock, min_stock);

CREATE TRIGGER trg_medication_updated_at
    BEFORE UPDATE ON medication
    FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =========================
-- 7) MEDICATION_SUPPLIER (many-to-many + purchase info)
-- =========================
CREATE TABLE medication_supplier (
                                     medication_id  BIGINT NOT NULL REFERENCES medication(id) ON DELETE CASCADE,
                                     supplier_id    BIGINT NOT NULL REFERENCES supplier(id)   ON DELETE CASCADE,
                                     purchase_price NUMERIC(12,2) NOT NULL DEFAULT 0,
                                     supplier_sku   VARCHAR(80),           -- supplier's reference for the same medication
                                     is_primary     BOOLEAN NOT NULL DEFAULT FALSE,
                                     created_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
                                     updated_at     TIMESTAMPTZ NOT NULL DEFAULT now(),
                                     PRIMARY KEY (medication_id, supplier_id),
                                     CONSTRAINT ck_purchase_price CHECK (purchase_price >= 0),
                                     CONSTRAINT uq_supplier_sku_per_supplier UNIQUE (supplier_id, supplier_sku)
);

CREATE INDEX idx_med_sup_supplier ON medication_supplier(supplier_id);
CREATE INDEX idx_med_sup_primary ON medication_supplier(medication_id, is_primary);

CREATE TRIGGER trg_medication_supplier_updated_at
    BEFORE UPDATE ON medication_supplier
    FOR EACH ROW EXECUTE FUNCTION set_updated_at();

-- =========================
-- 8) STOCK_MOVEMENT (IN / OUT / ADJUST)
-- =========================
CREATE TABLE stock_movement (
                                id            BIGSERIAL PRIMARY KEY,
                                medication_id BIGINT NOT NULL REFERENCES medication(id),
                                user_id       BIGINT NOT NULL REFERENCES app_user(id),
                                movement_type VARCHAR(10) NOT NULL, -- IN, OUT, ADJUST
                                quantity      INTEGER NOT NULL,
                                note          TEXT,
                                supplier_id   BIGINT REFERENCES supplier(id),
                                customer_id   BIGINT REFERENCES customer(id),
                                created_at    TIMESTAMPTZ NOT NULL DEFAULT now(),
                                updated_at    TIMESTAMPTZ NOT NULL DEFAULT now(),

                                CONSTRAINT ck_stock_movement_type CHECK (movement_type IN ('IN','OUT','ADJUST')),
                                CONSTRAINT ck_stock_movement_quantity CHECK (quantity > 0),

    -- Règles simples cohérentes :
    -- IN : supplier_id recommandé (mais pas obligatoire)
    -- OUT : customer_id recommandé (mais pas obligatoire)
    -- ADJUST : supplier_id et customer_id doivent être NULL (sinon incohérent)
                                CONSTRAINT ck_stock_movement_adjust_links CHECK (
                                    (movement_type <> 'ADJUST') OR (supplier_id IS NULL AND customer_id IS NULL)
                                    )
);

CREATE INDEX idx_stock_movement_medication ON stock_movement(medication_id);
CREATE INDEX idx_stock_movement_user ON stock_movement(user_id);
CREATE INDEX idx_stock_movement_type ON stock_movement(movement_type);
CREATE INDEX idx_stock_movement_created_at ON stock_movement(created_at);
CREATE INDEX idx_stock_movement_supplier ON stock_movement(supplier_id);
CREATE INDEX idx_stock_movement_customer ON stock_movement(customer_id);

CREATE TRIGGER trg_stock_movement_updated_at
    BEFORE UPDATE ON stock_movement
    FOR EACH ROW EXECUTE FUNCTION set_updated_at();
